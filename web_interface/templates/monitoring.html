<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/dashboard.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-brain"></i> Quantum Edge AI Platform
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <a class="nav-link" href="/models"><i class="fas fa-cubes"></i> Models</a>
                <a class="nav-link active" href="/monitoring"><i class="fas fa-chart-line"></i> Monitoring</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h2><i class="fas fa-chart-line text-primary"></i> System Monitoring</h2>

                <!-- Real-time Metrics -->
                <div class="row mt-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">CPU Usage</h5>
                                <h2 class="text-primary" id="cpuUsage">--</h2>
                                <div class="progress mt-2">
                                    <div class="progress-bar" id="cpuProgress" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">Memory Usage</h5>
                                <h2 class="text-success" id="memoryUsage">--</h2>
                                <div class="progress mt-2">
                                    <div class="progress-bar bg-success" id="memoryProgress" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">Disk Usage</h5>
                                <h2 class="text-warning" id="diskUsage">--</h2>
                                <div class="progress mt-2">
                                    <div class="progress-bar bg-warning" id="diskProgress" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">Active Connections</h5>
                                <h2 class="text-info" id="connections">--</h2>
                                <i class="fas fa-users text-info mt-2"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="row mt-4">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">System Metrics Over Time</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="metricsChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Resource Distribution</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="resourceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Logs Section -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">System Logs</h5>
                                <div>
                                    <select class="form-select form-select-sm d-inline-block w-auto" id="logLevel">
                                        <option value="all">All Levels</option>
                                        <option value="error">Errors</option>
                                        <option value="warning">Warnings</option>
                                        <option value="info">Info</option>
                                    </select>
                                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="clearLogs()">
                                        <i class="fas fa-trash"></i> Clear
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="logsContainer" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.875rem;">
                                    <div class="text-muted">Loading logs...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Metrics -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Model Performance</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="modelPerformanceChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">API Performance</h5>
                            </div>
                            <div class="card-body">
                                <div id="apiMetrics">
                                    <div class="row text-center">
                                        <div class="col-3">
                                            <h4 class="text-primary" id="totalRequests">--</h4>
                                            <small class="text-muted">Total Requests</small>
                                        </div>
                                        <div class="col-3">
                                            <h4 class="text-success" id="avgResponseTime">--</h4>
                                            <small class="text-muted">Avg Response (ms)</small>
                                        </div>
                                        <div class="col-3">
                                            <h4 class="text-warning" id="errorRate">--</h4>
                                            <small class="text-muted">Error Rate (%)</small>
                                        </div>
                                        <div class="col-3">
                                            <h4 class="text-info" id="uptime">--</h4>
                                            <small class="text-muted">Uptime</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let socket;
        let metricsChart;
        let resourceChart;
        let modelPerformanceChart;
        let metricsData = [];
        let logsData = [];

        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            initializeCharts();
            loadInitialData();
        });

        function initializeSocket() {
            socket = io();

            socket.on('connect', function() {
                console.log('Connected to monitoring server');
                socket.emit('subscribe_metrics');
            });

            socket.on('disconnect', function() {
                console.log('Disconnected from monitoring server');
            });

            socket.on('metrics_update', function(data) {
                updateMetrics(data);
            });

            socket.on('log_entry', function(log) {
                addLogEntry(log);
            });
        }

        function initializeCharts() {
            // System metrics chart
            const metricsCtx = document.getElementById('metricsChart').getContext('2d');
            metricsChart = new Chart(metricsCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CPU Usage (%)',
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        data: [],
                        tension: 0.4
                    }, {
                        label: 'Memory Usage (%)',
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        data: [],
                        tension: 0.4
                    }, {
                        label: 'Disk Usage (%)',
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        data: [],
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // Resource distribution chart
            const resourceCtx = document.getElementById('resourceChart').getContext('2d');
            resourceChart = new Chart(resourceCtx, {
                type: 'doughnut',
                data: {
                    labels: ['CPU', 'Memory', 'Disk', 'Available'],
                    datasets: [{
                        data: [25, 35, 20, 20],
                        backgroundColor: ['#007bff', '#28a745', '#ffc107', '#6c757d'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Model performance chart
            const modelCtx = document.getElementById('modelPerformanceChart').getContext('2d');
            modelPerformanceChart = new Chart(modelCtx, {
                type: 'bar',
                data: {
                    labels: ['ResNet-50', 'Quantum SVM', 'CNN', 'LSTM'],
                    datasets: [{
                        label: 'Inference Time (ms)',
                        data: [45, 120, 30, 85],
                        backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        async function loadInitialData() {
            try {
                // Load system info
                const systemResponse = await fetch('/api/system-info');
                const systemData = await systemResponse.json();
                updateSystemInfo(systemData);

                // Load initial metrics
                const metricsResponse = await fetch('/api/monitoring/metrics');
                const metrics = await metricsResponse.json();
                if (metrics.timestamp) {
                    updateMetrics(metrics);
                }

                // Load sample logs
                loadSampleLogs();

            } catch (error) {
                console.error('Error loading initial data:', error);
            }
        }

        function updateSystemInfo(data) {
            // Update displays with system information
            console.log('System info updated:', data);
        }

        function updateMetrics(data) {
            // Update metric displays
            if (data.cpu_percent !== undefined) {
                document.getElementById('cpuUsage').textContent = data.cpu_percent.toFixed(1) + '%';
                document.getElementById('cpuProgress').style.width = data.cpu_percent + '%';
            }

            if (data.memory_percent !== undefined) {
                document.getElementById('memoryUsage').textContent = data.memory_percent.toFixed(1) + '%';
                document.getElementById('memoryProgress').style.width = data.memory_percent + '%';
            }

            if (data.disk_percent !== undefined) {
                document.getElementById('diskUsage').textContent = data.disk_percent.toFixed(1) + '%';
                document.getElementById('diskProgress').style.width = data.disk_percent + '%';
            }

            if (data.active_clients !== undefined) {
                document.getElementById('connections').textContent = data.active_clients;
            }

            // Update charts
            updateMetricsChart(data);
            updateResourceChart(data);

            // Store data
            metricsData.push(data);
            if (metricsData.length > 50) {
                metricsData.shift();
            }
        }

        function updateMetricsChart(data) {
            const timestamp = new Date(data.timestamp).toLocaleTimeString();

            // Add new data point
            metricsChart.data.labels.push(timestamp);
            metricsChart.data.datasets[0].data.push(data.cpu_percent || 0);
            metricsChart.data.datasets[1].data.push(data.memory_percent || 0);
            metricsChart.data.datasets[2].data.push(data.disk_percent || 0);

            // Keep only last 20 points
            if (metricsChart.data.labels.length > 20) {
                metricsChart.data.labels.shift();
                metricsChart.data.datasets.forEach(dataset => dataset.data.shift());
            }

            metricsChart.update();
        }

        function updateResourceChart(data) {
            const used = (data.cpu_percent || 0) + (data.memory_percent || 0) + (data.disk_percent || 0);
            const available = 300 - used; // Assuming 100% per resource = 300 total

            resourceChart.data.datasets[0].data = [
                data.cpu_percent || 0,
                data.memory_percent || 0,
                data.disk_percent || 0,
                Math.max(0, available)
            ];

            resourceChart.update();
        }

        function addLogEntry(log) {
            logsData.unshift(log);
            if (logsData.length > 100) {
                logsData.pop();
            }

            updateLogsDisplay();
        }

        function updateLogsDisplay() {
            const container = document.getElementById('logsContainer');
            const logLevel = document.getElementById('logLevel').value;

            let filteredLogs = logsData;
            if (logLevel !== 'all') {
                filteredLogs = logsData.filter(log => log.level === logLevel);
            }

            container.innerHTML = filteredLogs.slice(0, 50).map(log => `
                <div class="log-entry log-${log.level}">
                    <span class="log-time">${new Date(log.timestamp).toLocaleTimeString()}</span>
                    <span class="badge bg-${getLogBadgeClass(log.level)} log-level">${log.level.toUpperCase()}</span>
                    <span class="log-message">${log.message}</span>
                </div>
            `).join('');
        }

        function getLogBadgeClass(level) {
            const classes = {
                'error': 'danger',
                'warning': 'warning',
                'info': 'info',
                'debug': 'secondary'
            };
            return classes[level] || 'secondary';
        }

        function loadSampleLogs() {
            // Generate sample log entries
            const sampleLogs = [
                { timestamp: Date.now() - 300000, level: 'info', message: 'System started successfully' },
                { timestamp: Date.now() - 240000, level: 'info', message: 'Model ResNet-50 loaded' },
                { timestamp: Date.now() - 180000, level: 'warning', message: 'High memory usage detected' },
                { timestamp: Date.now() - 120000, level: 'info', message: 'API request processed' },
                { timestamp: Date.now() - 60000, level: 'error', message: 'Failed to connect to database' },
                { timestamp: Date.now() - 30000, level: 'info', message: 'Quantum circuit optimized' },
                { timestamp: Date.now(), level: 'info', message: 'Monitoring dashboard accessed' }
            ];

            logsData = sampleLogs;
            updateLogsDisplay();
        }

        function clearLogs() {
            if (confirm('Are you sure you want to clear all logs?')) {
                logsData = [];
                updateLogsDisplay();
            }
        }

        // Update log filtering when level changes
        document.getElementById('logLevel').addEventListener('change', updateLogsDisplay);

        // Auto-refresh every 30 seconds
        setInterval(async () => {
            try {
                const response = await fetch('/api/system-info');
                const data = await response.json();
                updateSystemInfo(data);
            } catch (error) {
                console.error('Error refreshing data:', error);
            }
        }, 30000);
    </script>

    <style>
        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.875rem;
        }

        .log-time {
            color: #6c757d;
            margin-right: 8px;
        }

        .log-level {
            margin-right: 8px;
            font-size: 0.75rem;
        }

        .log-message {
            color: #495057;
        }

        .log-error .log-message { color: #dc3545; }
        .log-warning .log-message { color: #ffc107; }
        .log-info .log-message { color: #007bff; }
        .log-debug .log-message { color: #6c757d; }
    </style>
</body>
</html>
